{% extends 'videos/base.html' %}
{% block title %}Videos{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Videos</h1>
    <a class="btn btn-primary" href="{% url 'video-create' %}">Create Video</a>
</div>
<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <select name="status" class="form-select" aria-label="Filter by status">
            <option value="">All Statuses</option>
            <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="processing" {% if request.GET.status == 'processing' %}selected{% endif %}>Processing</option>
            <option value="ready" {% if request.GET.status == 'ready' %}selected{% endif %}>Ready</option>
            <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
            <option value="archived" {% if request.GET.status == 'archived' %}selected{% endif %}>Archived</option>
        </select>
    </div>
    <div class="col-md-3">
        <select name="mood" class="form-select" aria-label="Filter by mood">
            <option value="">All Moods</option>
            <option value="sad" {% if request.GET.mood == 'sad' %}selected{% endif %}>Sad</option>
            <option value="happy" {% if request.GET.mood == 'happy' %}selected{% endif %}>Happy</option>
            <option value="epic" {% if request.GET.mood == 'epic' %}selected{% endif %}>Epic</option>
            <option value="romantic" {% if request.GET.mood == 'romantic' %}selected{% endif %}>Romantic</option>
            <option value="dark" {% if request.GET.mood == 'dark' %}selected{% endif %}>Dark</option>
            <option value="chill" {% if request.GET.mood == 'chill' %}selected{% endif %}>Chill</option>
        </select>
    </div>
    <div class="col-md-4">
        <input type="text" name="search" class="form-control" placeholder="Search by title or tags" value="{{ request.GET.search }}">
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">Filter</button>
    </div>
</form>
<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Thumbnail</th>
                <th>Title</th>
                <th>Audio</th>
                <th>Mood</th>
                <th>Progress</th>
                <th>Status</th>
                <th>File</th>
                <th>Error</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for video in videos %}
            <tr>
                <td>
                    {% if video.thumbnail %}
                        <img src="{{ video.thumbnail.url }}" style="height:50px;" alt="thumb">
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ video.title }}</td>
                <td>{{ video.audio_track.title }}</td>
                <td>{{ video.mood|default:'-'|capfirst }}</td>
                <td style="min-width: 160px;">
                    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ video.generation_progress }}">
                        <div class="progress-bar {% if video.generation_progress == 100 %}bg-success{% else %}bg-info{% endif %}"
                             style="width: {{ video.generation_progress }}%">
                            {{ video.generation_progress }}%
                        </div>
                    </div>
                </td>
                <td>
                    {% if video.status == 'failed' %}
                        <span class="badge bg-danger">{{ video.status|capfirst }}</span>
                    {% elif video.status == 'processing' %}
                        <span class="badge bg-warning text-dark">{{ video.status|capfirst }}</span>
                    {% elif video.status == 'ready' %}
                        <span class="badge bg-success">{{ video.status|capfirst }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ video.status|capfirst }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if video.video_file %}
                        <span class="badge bg-success">Present</span>
                    {% else %}
                        <span class="badge bg-secondary">Missing</span>
                    {% endif %}
                </td>
                <td>
                    {% if video.error_message %}
                        <span class="text-danger" title="{{ video.error_message }}">{{ video.error_code|default:'Error' }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ video.created_at }}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-outline-primary" href="{% url 'video-detail' video.pk %}">View</a>
                        <a class="btn btn-outline-secondary" href="{% url 'video-edit' video.pk %}">Edit</a>
                        {% if user.is_staff %}
                            <a class="btn btn-outline-danger" href="{% url 'video-delete' video.pk %}">Delete</a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7">No videos found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if is_paginated %}
<nav>
    <ul class="pagination">
        {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endif %}
        <li class="page-item active"><span class="page-link">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
